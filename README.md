# price_predict

# Данные:
Для обеих задач модель выполняет прогнозирование на **12 временных шагов вперёд**, используя для анализа предыдущие **24 наблюдения**.<br>
Час и день кодируются **синусом и косинусом**.

Решается 2 задачи:
1. **Регрессия**
2. **Бинарная классификация**:
Бинарная классификация: если цена в предсказывемом окне отклоняется от послдней цены в X на 1% и более, то такой сэмпл относится к положительному классу

Код для бинарнйо классификации:<br>
Y = ((Y - X_time[:, -1:]) / X_time[:, -1:]) > 0.01<br>
Y = Y.sum(dim=1)<br>
Y[Y !=0 ] = 1

# Решение
Сравниваются 2 подхода:
1. LSTM 
2. LSTM + cross-attention:

Эмбеддинги временного ряда получаются через LSTM Эмбеддинги новостей через BERT(ai-forever-ruBert-base). Вектора проходят через cross-attention (Q-вектор временного ряда. K, V - вектора новостей). На выходе полносвязный слой с сигмоидой

## BERT
BERT предобучался семантической классификации на [датасетах](https://www.kaggle.com/datasets/mikezz11/telegram-financial-sentiment-ru):

1. 66к размеченных новостей (положительные, нейтральные, негативные)
2. 2.5к размеченных новостей с по тикерам компании упомянутых в тексте. Текста форматировались по шаблону: [тикер, имя_компании, сектор_экономики][SEP][текст_новости] 
   
# Результаты:
## Регрессия
1. **LSTM + cross-attention (по новостям с упоминанием компании)**

2. **LSTM**
## Классификация
1. **LSTM + cross-attention (по новостям с упоминанием компании)**
2. **LSTM**

---
- .env:<br>
подключение к БД (postgresql):

DB_USER='user'<br>
DB_PASS='password'<br>
DB_HOST='host.docker.internal'<br>
DB_PORT='5000'<br>
DB_NAME=db_alembic<br>
DB_NAME_AIRFLOW=airflow_db<br>

***Таблицы создаются скриптом db/init_psycopg.py либо через alembic (alembic upgrade e98e95bf701e)**

TOKEN_TINKOFF_API - ключи api от тинькофф инвстиций

API_ID, API_HASH - API для библиотеки telethon (не путать с telebot), получать [тут](https://my.telegram.org/auth?to=%3Fspm%3Da2ty_o01.29997173.0.0.7fdfc921LNM7KH)

- parser<br>
DESCRIBE_COMPANY.py - парсит описание компаний с сайта Тинькова<br>
  - dags<br>
    DAG* - airflow даги запускающие скрипты
    - scripts<br>
        TINKOFF.py - собирает цены по компаниям<br>
        TG_NEWS.py - выгружает новости с канала (брал РБК для примера)<br>
        TG_NEWS_TICKER.py - выгружает из всех каналов новости, где упоминается компания<br>
        *TG_AUTHORIZATION.py - после авторизации в консоли создает файл сессии telethon, для нормальной работы дргуих скриптов 

***все скрипты загружают данные в БД**
- models<br>
news_embedding.py, news_ticker_embedding.py - получение эмбеддингов по текстам из БД и загрузка обратно<br>
***Для хранения новостей и их векторов используются разные таблицы (вектора хранятся с использованием pgvector)**
- frc**.ipynb ноутбуки с обучением моделей

dockerfile - докидывает необходимые библиотеки для apache/airflow:2.9.3-python3.11
docker-compose.yml - для запуска airflow
